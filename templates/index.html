<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Data tables</title>
 
<link rel="stylesheet" type="text/css" media="screen" href={{url_for('static', filename="css/bootstrap.min.css") }} />
<style type="text/css">
    body {
        padding-top: 60px;
        padding-bottom: 40px;
        background: #f5f5f5;
    }
    .sidebar-nav {
        padding: 9px 0;
    }
    div.main-container {
        margin-left: auto;
        margin-right: auto;
        width: 740px;
        float: left;
    }
    div.switch {
        margin-bottom: 10px;
        margin-right: 10px;
        float: right;
    }
</style>
<link rel="stylesheet" type="text/css" media="screen" href={{url_for('static', filename="css/bootstrap-responsive.min.css") }} />
<link rel="stylesheet" type="text/css" media="screen" href={{url_for('static', filename="css/bootstrap-datatables.css") }} />
<link rel="stylesheet" type="text/css" media="screen" href={{url_for('static', filename="css/flick/jquery-ui-1.8.18.datepicker.css") }} />
</head>

<body>
    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container-fluid">
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <a class="brand" href="#">Indicator of Compromise Dashboard</a>
                <div class="nav-collapse">
                    <ul class="nav">
                        <li class="active"><a href="#">Home</a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span2">
                <div class="well sidebar-nav">
                    <ul class="nav nav-list">
                        <li class="nav-header">Execution time</li>
                        <li><input style="width: 90px;" id="exec_date" name="exec_date" maxlength="10" /></li>

                        <li class="nav-header">IOCs</li>
                        <li><div class="btn-group">
                            <button class="btn dropdown-toggle" data-toggle="dropdown">
                                Select IOCs
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" id="iocs-list">
                            </ul>
                            </div></li>

                        <li class="nav-header">Hosts</li>
                        <li><div class="btn-group">
                            <button class="btn dropdown-toggle" data-toggle="dropdown">
                                Select Hosts
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" id="hosts-list">
                            </ul>
                            </div>
                        </li>

                        <li class="nav-header">Category</li>
                            <li id="categories-list">
                            </li>

                        <li class="nav-header">Severity</li>
                            <li>
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="0" />0</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="10" />10</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="20" />20</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="30" />30</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="40" />40</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="50" />50</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="60" />60</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="70" />70</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="80" />80</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="90" />90</label> 
                            <label class="checkbox"><input type="checkbox" name="severity[]" value="100"/>100</label> 
                            </li>

                        <li class="nav-header">Confidence</li>
                            <li>
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="0" />0</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="10" />10</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="20" />20</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="30" />30</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="40" />40</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="50" />50</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="60" />60</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="70" />70</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="80" />80</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="90" />90</label> 
                            <label class="checkbox"><input type="checkbox" name="confidence[]" value="100"/>100</label> 
                            </li>

                    </ul>
                </div><!--/.well -->
            </div><!--/span-->
            <div class="span10">
                <div class="main-container">
                    <div class="switch btn-group">
                        <label>Sum by</label>
                        <button class="btn btn-primary disabled" id="severity-btn">Severity</button>
                        <button class="btn" id="count-btn">Host count</button>
                    </div>
                    <div class="switch btn-group">
                        <label>Group by</label>
                        <button class="btn btn-primary disabled" id="ioc-btn">IOC</button>
                        <button class="btn" id="host-btn">Host</button>
                    </div>
                    <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="tg_results">
                        <thead>
                            <tr>
                                <th width="75%" id="column1">Title</th>
                                <th width="25%">Sum</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2" class="dataTables_empty">Loading data from server</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div><!--/span-->
        </div><!--/row-->
        <footer>
        <p>&copy; Company 2012</p>
        </footer>

    </div><!--/.fluid-container-->

<!-- Javascript
================================================================================= -->
<script type=text/javascript src="{{url_for('static', filename='js/jquery-1.7.1.min.js') }}"></script>
<script type=text/javascript src="{{url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
<script type=text/javascript src="{{url_for('static', filename='js/bootstrap.min.js') }}"></script>
<script type=text/javascript src="{{url_for('static', filename='js/bootstrap-datatables.js') }}"></script>
<script type=text/javascript src="{{url_for('static', filename='js/jquery-ui-1.8.18.datepicker.min.js') }}"></script>
<script type=text/javascript>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>
<script type="text/javascript" charset="utf-8">
    function dump(arr,level) {
        var dumped_text = "";
        if(!level) level = 0;

        //The padding given at the beginning of the line.
        var level_padding = "";
        for(var j=0;j<level+1;j++) level_padding += "    ";

        if(typeof(arr) == 'object') { //Array/Hashes/Objects 
            for(var item in arr) {
                var value = arr[item];

                if(typeof(value) == 'object') { //If it is an array,
                    dumped_text += level_padding + "'" + item + "' ...\n";
                    dumped_text += dump(value,level+1);
                } else {
                    dumped_text += level_padding + "'" + item + "' => \"" + value + "\"\n";
                }
            }
        } else { //Stings/Chars/Numbers etc.
            dumped_text = "===>"+arr+"<===("+typeof(arr)+")";
        }
        return dumped_text;
    }

    /* Global vars */
    var SEVERITY = 'severity';
    var IOC_COUNT = 'ioc_count';
    var HOST_COUNT = 'host_count';

    var group_by = 'ioc';
    var sum_by = SEVERITY;

    var source_iocs = $SCRIPT_ROOT + "/_get_iocs";
    var source_hosts = $SCRIPT_ROOT + "/_get_host_binaries";

    /* Table initialisation */
    var loadDataTable = function(ajaxSource) {
        $('#tg_results').dataTable( {
                    "bProcessing": true,
                    "bServerSide": true,
                    "bDestroy": true,
                    "bAutoWidth": false,
                    "aoColumnDefs": [{ "bSortable": false, "aTargets": [ 0 ] }],
                    "aaSorting": [[ 1, "desc" ]],
                    "sAjaxSource": ajaxSource,
                    "sDom": "<'row-fluid'r>t<'row-fluid'<'span6'i><'span6'p>>",
                    "sPaginationType": "bootstrap",
                    "oLanguage": {"sLengthMenu": "_MENU_ records per page"},
                    "fnServerParams": function ( aoData ) {
                        aoData.push( { "name" : "sSumBy", "value" : sum_by } );
                    }
            });
    }
    $(function() {
        // load ioc source first time
        loadDataTable(source_iocs); 

        // add group by ioc and host button handlers
        $('#ioc-btn').click(function () {
              group_by = 'ioc';
              if (sum_by == IOC_COUNT) {
                  sum_by = HOST_COUNT;
              }
              $(this).addClass('btn-primary disabled');
              $('#host-btn').removeClass('btn-primary disabled');
              $('#count-btn').text('Host count');
              $('#column1').text('Title');
              loadDataTable(source_iocs);
        });
        $('#host-btn').click(function () {
              group_by = 'host';
              if (sum_by == HOST_COUNT) {
                  sum_by = IOC_COUNT;
              }
              $(this).addClass('btn-primary disabled');
              $('#ioc-btn').removeClass('btn-primary disabled');
              $('#count-btn').text('IOC count');
              $('#column1').text('Host');
              loadDataTable(source_hosts);
        });

        // add sum by button handlers
        $('#severity-btn').click(function () {
            if (sum_by != SEVERITY) {
                  sum_by = SEVERITY;
                  $(this).addClass('btn-primary disabled');
                  $('#count-btn').removeClass('btn-primary disabled');
                  if (group_by == 'ioc') {
                      $('#ioc-btn').click();
                  } else {
                      $('#host-btn').click();
                  }
              }
        });
        $('#count-btn').click(function () {
            if (sum_by == SEVERITY) {
                $(this).addClass('btn-primary disabled');
                $('#severity-btn').removeClass('btn-primary disabled');
                if (group_by == 'ioc')
                {
                    sum_by = HOST_COUNT;
                    $('#ioc-btn').click();
                } else {
                    sum_by = IOC_COUNT;
                    $('#host-btn').click();
                }
            }
        });

        // populate iocs with json queries
        $.getJSON($SCRIPT_ROOT + "/_populate_iocs",
                  function (data) {
                      var items = []
                      $.each(data.iocs, function(ind, row) {items.push('<li><a href="#">' + row[0] + ', ' + row[1] + '</a></li>');});
                      $(items.join('\n')).appendTo('ul #iocs-list');
                  });
        // populate hosts
        $.getJSON($SCRIPT_ROOT + "/_populate_hosts",
                  function (data) {
                      var items = []
                      $.each(data.hosts, function(ind, row) {items.push('<li><a href="#">' + row[0] + '</a></li>');});
                      $(items.join('\n')).appendTo('ul #hosts-list');
                  });
        // populate categories
        $.getJSON($SCRIPT_ROOT + "/_populate_categories",
                  function (data) {
                      var items = []
                      $.each(data.categories, function(ind, row) {items.push('<label class="checkbox"><input type="checkbox" name="category[]" value="' + row + '"/>' + row + '</label>');});
                      $(items.join('\n')).appendTo('ul #categories-list');
                  });
    } );
    $(function() {
        $("#exec_date").datepicker({ maxDate: "+0D" });
    });
</script>
</body>

</html>

